<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitoring Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2kP3fQ1f1gqXnq6k4sA1Qb0u6V6j2H0f6k6FJ3M=" crossorigin=""/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #000; color: #fff; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .tile { border: 1px solid #fff; padding: 10px; background: #222; }
    #map-earthquakes, #map-bushfires { height: 400px; border: 1px solid #222; background: #000; }
    .muted { color:#bbb; font-size:0.9em; }
  </style>
</head>
<body>
  <h1>Monitoring Dashboard</h1>

  <section>
    <h2>Maps (no iframes) + Radar Overlay</h2>
    <div class="grid">
      <div class="tile">
        <h3>Earthquakes (map + list)</h3>
        <div id="earthquakes" style="height:200px; overflow:auto;" class="muted"></div>
        <div id="map-earthquakes"></div>
      </div>
      <div class="tile">
        <h3>Bushfires (map + list)</h3>
        <div id="bushfire-list" style="height:200px; overflow:auto;" class="muted"></div>
        <div id="map-bushfires"></div>
      </div>
    </div>
    <p class="muted">Radar overlay: RainViewer (public tiles, no API key required). Use the layer control to toggle radar. If the radar doesn't appear, check console network errors.</p>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-XXXXXXXXXXXXX" crossorigin=""></script>

  <script>
    // After you deploy the worker, set: PROXY_BASE = 'https://your-worker.workers.dev?url='
    const PROXY_BASE = 'REPLACE_WITH_YOUR_WORKER_URL?url=';

    function proxyUrl(url) {
      if (!PROXY_BASE || PROXY_BASE.startsWith('REPLACE')) {
        // Temporary fallback for quick local testing:
        return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      }
      return PROXY_BASE + encodeURIComponent(url);
    }

    // Leaflet map init
    const eqMap = L.map('map-earthquakes').setView([-25, 133], 4);
    const bushMap = L.map('map-bushfires').setView([-33.86, 151.2], 5);
    const tiles = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    L.tileLayer(tiles, { attribution: '&copy; OpenStreetMap contributors' }).addTo(eqMap);
    L.tileLayer(tiles, { attribution: '&copy; OpenStreetMap contributors' }).addTo(bushMap);

    // Radar overlay via RainViewer (no API key)
    // We'll fetch maps.json to get the latest timestamps then add the most recent radar layer
    async function addRainViewerOverlay(map, layerName = 'RainViewer Radar') {
      try {
        const resp = await fetch('https://api.rainviewer.com/public/maps.json');
        if (!resp.ok) throw new Error('RainViewer maps.json fetch failed: ' + resp.status);
        const json = await resp.json();
        // json.radar.timestamps is an array of UNIX timestamps (seconds)
        const timestamps = json.radar && json.radar.past || json.radar || json;
        // RainViewer v2 uses json.radar.past (array)
        const times = Array.isArray(timestamps) ? timestamps : (json.radar && json.radar.past ? json.radar.past : []);
        if (!times.length) {
          console.warn('RainViewer returned no timestamps', json);
          return null;
        }
        // choose the latest timestamp
        const latest = times[times.length - 1];
        // Tile URL format:
        const tileUrl = `https://tile.rainviewer.com/v2/radar/${latest}/{z}/{x}/{y}.png`;
        const radarLayer = L.tileLayer(tileUrl, { opacity: 0.5, attribution: '&copy; RainViewer' });
        // Add to map but not displayed by default - return layer to be added to control
        return { layer: radarLayer, label: layerName };
      } catch (err) {
        console.warn('Failed to add RainViewer overlay', err);
        return null;
      }
    }

    // Add radar overlays to both maps and a layer control
    (async function() {
      const overlayPromises = [
        addRainViewerOverlay(eqMap),
        addRainViewerOverlay(bushMap)
      ];
      const overlays = await Promise.all(overlayPromises);
      // Add first overlay to eqMap and bushMap
      const controls = {};
      overlays.forEach((o, i) => {
        if (!o) return;
        if (i === 0) {
          o.layer.addTo(eqMap);
          controls[o.label + ' (Earthquakes)'] = o.layer;
        } else {
          o.layer.addTo(bushMap);
          controls[o.label + ' (Bushfires)'] = o.layer;
        }
      });
      // A simple layer control attached to one of the maps (others already have overlays)
      if (Object.keys(controls).length) {
        L.control.layers({}, controls, { collapsed: false }).addTo(eqMap);
      }
    })();

    // Existing data loaders (earthquakes, bushfires) - similar to prior code
    async function loadEarthquakes() {
      const out = document.getElementById('earthquakes');
      out.innerText = 'Loading...';
      try {
        const r = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson');
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const data = await r.json();
        eqMap.eachLayer(layer => { if (layer instanceof L.Marker) eqMap.removeLayer(layer); });
        let html = '';
        (data.features || []).forEach(feature => {
          const props = feature.properties;
          const coords = feature.geometry?.coordinates || [];
          const lat = coords[1], lon = coords[0];
          const timeAEST = props.time ? new Date(props.time).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : '';
          html += `<div><strong>${props.title}</strong><div class="muted">Mag: ${props.mag} â€¢ ${timeAEST} AEST</div><a href="${props.url}" target="_blank">Details</a></div><hr>`;
          if (lat && lon) {
            const m = L.marker([lat, lon]).addTo(eqMap);
            m.bindPopup(`<strong>${props.title}</strong><br/>Mag: ${props.mag}<br/>${timeAEST} AEST<br/><a href="${props.url}" target="_blank">Details</a>`);
          }
        });
        out.innerHTML = html || '<p>No recent earthquakes.</p>';
      } catch (err) {
        console.error('loadEarthquakes error', err);
        out.innerHTML = '<p>Error loading earthquake data.</p>';
      }
    }

    async function loadBushfires() {
      const out = document.getElementById('bushfire-list');
      out.innerText = 'Loading...';
      const rssUrl = 'https://www.rfs.nsw.gov.au/feeds/majorIncidents.xml';
      try {
        const r = await fetch(proxyUrl(rssUrl));
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const text = await r.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, 'text/xml');
        const items = Array.from(xml.querySelectorAll('item')).slice(0, 20);
        let html = '';
        bushMap.eachLayer(layer => { if (layer instanceof L.Marker) bushMap.removeLayer(layer); });
        items.forEach(item => {
          const title = item.querySelector('title')?.textContent || '(no title)';
          const link = item.querySelector('link')?.textContent || '';
          const pubDate = item.querySelector('pubDate')?.textContent || '';
          const dateAEST = pubDate ? new Date(pubDate).toLocaleString('en-AU', { timeZone: 'Australia/Sydney' }) : '';
          html += `<div><strong><a href="${link}" target="_blank">${title}</a></strong><div class="muted">${dateAEST} AEST</div><div>${item.querySelector('description')?.textContent || ''}</div></div><hr>`;

          // try georss:point
          const georss = item.getElementsByTagName('georss:point')[0] || item.getElementsByTagName('point')[0];
          if (georss && georss.textContent) {
            const parts = georss.textContent.trim().split(/\s+/);
            if (parts.length >= 2) {
              const lat = parseFloat(parts[0]), lon = parseFloat(parts[1]);
              if (!isNaN(lat) && !isNaN(lon)) {
                const m = L.marker([lat, lon]).addTo(bushMap);
                m.bindPopup(`<strong>${title}</strong><br/>${dateAEST} AEST<br/><a href="${link}" target="_blank">Details</a>`);
              }
            }
          }
        });
        out.innerHTML = html || '<p>No bushfire items.</p>';
      } catch (err) {
        console.error('loadBushfires error', err);
        out.innerHTML = `<p>Error loading bushfire feed. Open it <a href="${rssUrl}" target="_blank">here</a>. (${err.message})</p>`;
      }
    }

    // start
    window.addEventListener('load', () => {
      loadEarthquakes();
      loadBushfires();
      setInterval(() => { loadEarthquakes(); loadBushfires(); }, 60000);
    });
  </script>
</body>
</html>
